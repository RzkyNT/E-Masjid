<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Toggle Property Tests - Unifikasi Jadwal Jumat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-pass { color: #10b981; }
        .test-fail { color: #ef4444; }
        .test-running { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">
            <i class="fas fa-flask mr-3"></i>View Toggle Property Tests
        </h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Configuration</h2>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <strong>Feature:</strong> unifikasi-jadwal-jumat<br>
                    <strong>Property 1:</strong> View Toggle Functionality<br>
                    <strong>Validates:</strong> Requirements 1.4
                </div>
                <div>
                    <strong>Test Iterations:</strong> <span id="iterations">100</span><br>
                    <strong>Test Framework:</strong> Custom Property-Based Testing<br>
                    <strong>Target:</strong> View Toggle State Management
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Property Definition</h2>
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                <p class="text-blue-800">
                    <strong>Property 1: View Toggle Functionality</strong><br>
                    <em>For any</em> user session, switching between card view and calendar view should preserve all loaded data and maintain the current state without requiring a page reload
                </p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="flex space-x-4">
                <button id="runTests" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-play mr-2"></i>Run Property Tests
                </button>
                <button id="clearResults" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>Clear Results
                </button>
                <input type="number" id="iterationCount" value="100" min="10" max="1000" 
                       class="px-3 py-2 border border-gray-300 rounded-lg w-24">
                <label for="iterationCount" class="flex items-center text-gray-700">iterations</label>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="testResults" class="space-y-4">
                <p class="text-gray-500">Click "Run Property Tests" to start testing...</p>
            </div>
        </div>
    </div>

    <!-- Mock DOM Elements for Testing -->
    <div id="testContainer" class="hidden">
        <!-- Mock view toggle buttons -->
        <button id="cardViewBtn" class="bg-green-600 text-white">Card View</button>
        <button id="calendarViewBtn" class="text-gray-600">Calendar View</button>
        
        <!-- Mock view containers -->
        <div id="cardView" class="view-container">
            <div class="schedule-data" data-count="5">Card View Content</div>
        </div>
        <div id="calendarView" class="view-container hidden">
            <div class="calendar-data" data-events="3">Calendar View Content</div>
        </div>
    </div>

    <script>
        /**
         * Property-Based Test Framework for View Toggle Functionality
         * Feature: unifikasi-jadwal-jumat, Property 1: View Toggle Functionality
         */

        class ViewTogglePropertyTest {
            constructor() {
                this.iterations = 100;
                this.results = [];
                this.currentView = 'card';
                this.mockData = {
                    schedules: [],
                    calendarEvents: []
                };
            }

            // Generator for random test scenarios
            generateTestScenario() {
                return {
                    initialView: Math.random() < 0.5 ? 'card' : 'calendar',
                    switchSequence: this.generateSwitchSequence(),
                    dataState: this.generateMockDataState(),
                    userInteractions: this.generateUserInteractions()
                };
            }

            generateSwitchSequence() {
                const length = Math.floor(Math.random() * 10) + 1; // 1-10 switches
                const sequence = [];
                let currentView = Math.random() < 0.5 ? 'card' : 'calendar';
                
                for (let i = 0; i < length; i++) {
                    const nextView = currentView === 'card' ? 'calendar' : 'card';
                    sequence.push({
                        from: currentView,
                        to: nextView,
                        delay: Math.floor(Math.random() * 100) // Random delay 0-99ms
                    });
                    currentView = nextView;
                }
                
                return sequence;
            }

            generateMockDataState() {
                const scheduleCount = Math.floor(Math.random() * 20) + 1; // 1-20 schedules
                const schedules = [];
                
                for (let i = 0; i < scheduleCount; i++) {
                    schedules.push({
                        id: i + 1,
                        date: this.generateRandomFridayDate(),
                        imam: `Imam ${i + 1}`,
                        khotib: `Khotib ${i + 1}`,
                        theme: `Theme ${i + 1}`,
                        loaded: true
                    });
                }
                
                return { schedules, loadTime: Date.now() };
            }

            generateRandomFridayDate() {
                const today = new Date();
                const daysToAdd = Math.floor(Math.random() * 365); // Random day within a year
                const futureDate = new Date(today.getTime() + (daysToAdd * 24 * 60 * 60 * 1000));
                
                // Adjust to next Friday
                const dayOfWeek = futureDate.getDay();
                const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
                futureDate.setDate(futureDate.getDate() + daysUntilFriday);
                
                return futureDate.toISOString().split('T')[0];
            }

            generateUserInteractions() {
                const interactions = [];
                const interactionCount = Math.floor(Math.random() * 5) + 1; // 1-5 interactions
                
                for (let i = 0; i < interactionCount; i++) {
                    interactions.push({
                        type: Math.random() < 0.7 ? 'click' : 'keyboard',
                        timing: Math.floor(Math.random() * 1000), // Random timing
                        element: Math.random() < 0.5 ? 'cardViewBtn' : 'calendarViewBtn'
                    });
                }
                
                return interactions;
            }

            // Mock DOM manipulation for testing
            setupMockDOM(scenario) {
                const cardViewBtn = document.getElementById('cardViewBtn');
                const calendarViewBtn = document.getElementById('calendarViewBtn');
                const cardView = document.getElementById('cardView');
                const calendarView = document.getElementById('calendarView');

                // Reset to initial state
                this.currentView = scenario.initialView;
                
                if (scenario.initialView === 'card') {
                    cardViewBtn.classList.add('bg-green-600', 'text-white');
                    cardViewBtn.classList.remove('text-gray-600');
                    calendarViewBtn.classList.add('text-gray-600');
                    calendarViewBtn.classList.remove('bg-green-600', 'text-white');
                    cardView.classList.remove('hidden');
                    calendarView.classList.add('hidden');
                } else {
                    calendarViewBtn.classList.add('bg-green-600', 'text-white');
                    calendarViewBtn.classList.remove('text-gray-600');
                    cardViewBtn.classList.add('text-gray-600');
                    cardViewBtn.classList.remove('bg-green-600', 'text-white');
                    calendarView.classList.remove('hidden');
                    cardView.classList.add('hidden');
                }

                // Set mock data
                const scheduleData = cardView.querySelector('.schedule-data');
                const calendarData = calendarView.querySelector('.calendar-data');
                
                if (scheduleData) {
                    scheduleData.setAttribute('data-count', scenario.dataState.schedules.length);
                    scheduleData.setAttribute('data-load-time', scenario.dataState.loadTime);
                }
                
                if (calendarData) {
                    calendarData.setAttribute('data-events', scenario.dataState.schedules.length);
                    calendarData.setAttribute('data-load-time', scenario.dataState.loadTime);
                }
            }

            // Simulate view toggle
            simulateViewToggle(fromView, toView) {
                const cardViewBtn = document.getElementById('cardViewBtn');
                const calendarViewBtn = document.getElementById('calendarViewBtn');
                const cardView = document.getElementById('cardView');
                const calendarView = document.getElementById('calendarView');

                // Capture data state before switch
                const beforeState = this.captureDataState();

                // Perform the switch
                if (toView === 'card') {
                    cardViewBtn.classList.add('bg-green-600', 'text-white');
                    cardViewBtn.classList.remove('text-gray-600');
                    calendarViewBtn.classList.add('text-gray-600');
                    calendarViewBtn.classList.remove('bg-green-600', 'text-white');
                    cardView.classList.remove('hidden');
                    calendarView.classList.add('hidden');
                } else {
                    calendarViewBtn.classList.add('bg-green-600', 'text-white');
                    calendarViewBtn.classList.remove('text-gray-600');
                    cardViewBtn.classList.add('text-gray-600');
                    cardViewBtn.classList.remove('bg-green-600', 'text-white');
                    calendarView.classList.remove('hidden');
                    cardView.classList.add('hidden');
                }

                this.currentView = toView;

                // Capture data state after switch
                const afterState = this.captureDataState();

                return { beforeState, afterState };
            }

            captureDataState() {
                const scheduleData = document.querySelector('.schedule-data');
                const calendarData = document.querySelector('.calendar-data');
                
                return {
                    scheduleCount: scheduleData ? parseInt(scheduleData.getAttribute('data-count')) : 0,
                    calendarEvents: calendarData ? parseInt(calendarData.getAttribute('data-events')) : 0,
                    scheduleLoadTime: scheduleData ? scheduleData.getAttribute('data-load-time') : null,
                    calendarLoadTime: calendarData ? calendarData.getAttribute('data-load-time') : null,
                    currentView: this.currentView,
                    timestamp: Date.now()
                };
            }

            // Property validation
            validateViewToggleProperty(scenario, switchResults) {
                const errors = [];

                // Property 1: Data preservation during view switches
                for (let i = 0; i < switchResults.length; i++) {
                    const result = switchResults[i];
                    const { beforeState, afterState } = result;

                    // Check data count preservation
                    if (beforeState.scheduleCount !== afterState.scheduleCount) {
                        errors.push(`Switch ${i + 1}: Schedule count changed from ${beforeState.scheduleCount} to ${afterState.scheduleCount}`);
                    }

                    if (beforeState.calendarEvents !== afterState.calendarEvents) {
                        errors.push(`Switch ${i + 1}: Calendar events changed from ${beforeState.calendarEvents} to ${afterState.calendarEvents}`);
                    }

                    // Check load time preservation (data should not be reloaded)
                    if (beforeState.scheduleLoadTime !== afterState.scheduleLoadTime) {
                        errors.push(`Switch ${i + 1}: Schedule data was reloaded (load time changed)`);
                    }

                    if (beforeState.calendarLoadTime !== afterState.calendarLoadTime) {
                        errors.push(`Switch ${i + 1}: Calendar data was reloaded (load time changed)`);
                    }

                    // Check view state consistency
                    const expectedView = scenario.switchSequence[i].to;
                    if (afterState.currentView !== expectedView) {
                        errors.push(`Switch ${i + 1}: Expected view '${expectedView}' but got '${afterState.currentView}'`);
                    }
                }

                // Check localStorage persistence (if applicable)
                const savedView = localStorage.getItem('fridayScheduleView');
                const finalView = switchResults.length > 0 ? 
                    scenario.switchSequence[scenario.switchSequence.length - 1].to : 
                    scenario.initialView;
                
                if (savedView !== finalView) {
                    errors.push(`View preference not saved correctly: expected '${finalView}' but localStorage has '${savedView}'`);
                }

                return {
                    passed: errors.length === 0,
                    errors: errors,
                    scenario: scenario,
                    switchCount: switchResults.length
                };
            }

            // Run a single property test iteration
            async runSingleTest(iteration) {
                try {
                    // Generate test scenario
                    const scenario = this.generateTestScenario();
                    
                    // Setup mock DOM
                    this.setupMockDOM(scenario);
                    
                    // Execute switch sequence
                    const switchResults = [];
                    for (const switchOp of scenario.switchSequence) {
                        // Add random delay to simulate real user interaction
                        if (switchOp.delay > 0) {
                            await new Promise(resolve => setTimeout(resolve, switchOp.delay));
                        }
                        
                        const result = this.simulateViewToggle(switchOp.from, switchOp.to);
                        switchResults.push(result);
                    }
                    
                    // Validate property
                    const validation = this.validateViewToggleProperty(scenario, switchResults);
                    
                    return {
                        iteration: iteration,
                        passed: validation.passed,
                        errors: validation.errors,
                        scenario: scenario,
                        switchCount: validation.switchCount,
                        executionTime: Date.now()
                    };
                    
                } catch (error) {
                    return {
                        iteration: iteration,
                        passed: false,
                        errors: [`Test execution error: ${error.message}`],
                        scenario: null,
                        switchCount: 0,
                        executionTime: Date.now()
                    };
                }
            }

            // Run all property tests
            async runAllTests() {
                this.results = [];
                const startTime = Date.now();
                
                this.updateResults(`Starting ${this.iterations} property test iterations...`, 'test-running');
                
                for (let i = 1; i <= this.iterations; i++) {
                    const result = await this.runSingleTest(i);
                    this.results.push(result);
                    
                    // Update progress every 10 iterations
                    if (i % 10 === 0) {
                        const passed = this.results.filter(r => r.passed).length;
                        const failed = this.results.filter(r => !r.passed).length;
                        this.updateResults(`Progress: ${i}/${this.iterations} - Passed: ${passed}, Failed: ${failed}`, 'test-running');
                    }
                }
                
                const endTime = Date.now();
                const executionTime = endTime - startTime;
                
                // Generate final report
                this.generateReport(executionTime);
            }

            updateResults(message, className = '') {
                const resultsDiv = document.getElementById('testResults');
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-3 rounded ${className}`;
                messageDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
                resultsDiv.appendChild(messageDiv);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }

            generateReport(executionTime) {
                const passed = this.results.filter(r => r.passed).length;
                const failed = this.results.filter(r => !r.passed).length;
                const passRate = ((passed / this.iterations) * 100).toFixed(2);
                
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.innerHTML = '';
                
                // Summary
                const summaryClass = failed === 0 ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
                const summaryIcon = failed === 0 ? 'fa-check-circle' : 'fa-exclamation-triangle';
                
                resultsDiv.innerHTML = `
                    <div class="border rounded-lg p-4 ${summaryClass}">
                        <h3 class="font-semibold flex items-center">
                            <i class="fas ${summaryIcon} mr-2"></i>
                            Property Test Results Summary
                        </h3>
                        <div class="mt-2 grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong>Total Iterations:</strong> ${this.iterations}<br>
                                <strong>Passed:</strong> ${passed}<br>
                                <strong>Failed:</strong> ${failed}
                            </div>
                            <div>
                                <strong>Pass Rate:</strong> ${passRate}%<br>
                                <strong>Execution Time:</strong> ${executionTime}ms<br>
                                <strong>Status:</strong> ${failed === 0 ? 'PASSED' : 'FAILED'}
                            </div>
                        </div>
                    </div>
                `;
                
                // Failure details
                if (failed > 0) {
                    const failures = this.results.filter(r => !r.passed);
                    const failureDetails = document.createElement('div');
                    failureDetails.className = 'mt-4 bg-red-50 border border-red-200 rounded-lg p-4';
                    failureDetails.innerHTML = `
                        <h4 class="font-semibold text-red-800 mb-3">
                            <i class="fas fa-bug mr-2"></i>Failure Details (First 5)
                        </h4>
                        <div class="space-y-2 text-sm">
                            ${failures.slice(0, 5).map(failure => `
                                <div class="bg-white border border-red-200 rounded p-3">
                                    <strong>Iteration ${failure.iteration}:</strong>
                                    <ul class="mt-1 ml-4 list-disc text-red-700">
                                        ${failure.errors.map(error => `<li>${error}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    resultsDiv.appendChild(failureDetails);
                }
                
                // Statistics
                const stats = this.calculateStatistics();
                const statsDiv = document.createElement('div');
                statsDiv.className = 'mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4';
                statsDiv.innerHTML = `
                    <h4 class="font-semibold text-blue-800 mb-3">
                        <i class="fas fa-chart-bar mr-2"></i>Test Statistics
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-sm text-blue-700">
                        <div>
                            <strong>Avg Switches per Test:</strong> ${stats.avgSwitches}<br>
                            <strong>Max Switches:</strong> ${stats.maxSwitches}<br>
                            <strong>Min Switches:</strong> ${stats.minSwitches}
                        </div>
                        <div>
                            <strong>Total Switches Tested:</strong> ${stats.totalSwitches}<br>
                            <strong>Unique Scenarios:</strong> ${stats.uniqueScenarios}<br>
                            <strong>Coverage:</strong> ${stats.coverage}%
                        </div>
                    </div>
                `;
                resultsDiv.appendChild(statsDiv);
            }

            calculateStatistics() {
                const switchCounts = this.results.map(r => r.switchCount);
                const totalSwitches = switchCounts.reduce((sum, count) => sum + count, 0);
                const avgSwitches = (totalSwitches / this.iterations).toFixed(2);
                const maxSwitches = Math.max(...switchCounts);
                const minSwitches = Math.min(...switchCounts);
                
                // Estimate unique scenarios (simplified)
                const uniqueScenarios = new Set(this.results.map(r => 
                    r.scenario ? JSON.stringify(r.scenario.switchSequence) : ''
                )).size;
                
                // Coverage estimation (percentage of different switch patterns tested)
                const coverage = Math.min(100, (uniqueScenarios / this.iterations * 100)).toFixed(1);
                
                return {
                    avgSwitches,
                    maxSwitches,
                    minSwitches,
                    totalSwitches,
                    uniqueScenarios,
                    coverage
                };
            }

            clearResults() {
                document.getElementById('testResults').innerHTML = '<p class="text-gray-500">Click "Run Property Tests" to start testing...</p>';
                this.results = [];
            }
        }

        // Initialize test framework
        const viewToggleTest = new ViewTogglePropertyTest();

        // Event listeners
        document.getElementById('runTests').addEventListener('click', async function() {
            const iterationInput = document.getElementById('iterationCount');
            viewToggleTest.iterations = parseInt(iterationInput.value) || 100;
            document.getElementById('iterations').textContent = viewToggleTest.iterations;
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running Tests...';
            
            try {
                await viewToggleTest.runAllTests();
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-play mr-2"></i>Run Property Tests';
            }
        });

        document.getElementById('clearResults').addEventListener('click', function() {
            viewToggleTest.clearResults();
        });

        // Initialize localStorage mock for testing
        if (typeof(Storage) !== "undefined") {
            // localStorage is available
            console.log("localStorage available for testing");
        } else {
            // Mock localStorage for testing environments
            window.localStorage = {
                getItem: function(key) { return this[key] || null; },
                setItem: function(key, value) { this[key] = value; },
                removeItem: function(key) { delete this[key]; }
            };
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal JavaScript Unit Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .test-result {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .test-pass {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .test-fail {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .test-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Modal JavaScript Unit Tests</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Test Controls -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
                
                <div class="space-y-4">
                    <div class="flex space-x-3">
                        <button onclick="runAllTests()" 
                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Run All Tests
                        </button>
                        <button onclick="runBasicTests()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Run Basic Tests
                        </button>
                        <button onclick="runEventTests()" 
                                class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            Run Event Tests
                        </button>
                        <button onclick="clearResults()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                            Clear Results
                        </button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-2">Test Summary</h3>
                    <div id="testSummary" class="text-sm text-gray-600">
                        No tests run yet
                    </div>
                </div>
            </div>
            
            <!-- Test Results -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Test Results</h2>
                <div id="testResults" class="max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-sm">Test results will appear here...</div>
                </div>
            </div>
        </div>
        
        <!-- Test Modals -->
        <div id="testModal1" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900" id="testModal1-title">Test Modal 1</h3>
                    <button onclick="closeModal('testModal1')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6" id="testModal1-body">
                    <p>Test modal content</p>
                </div>
            </div>
        </div>
        
        <div id="testModal2" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" 
             data-backdrop-close="false" data-escape-close="false">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900" id="testModal2-title">Test Modal 2</h3>
                </div>
                <div class="p-6" id="testModal2-body">
                    <p>Modal without close options</p>
                </div>
                <div class="p-6 border-t">
                    <button onclick="closeModal('testModal2')" class="px-4 py-2 bg-gray-600 text-white rounded">
                        Close Manually
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Friday Schedule Test Modal -->
        <div id="fridayTestModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900" id="fridayTestModal-title">Friday Schedule Test</h3>
                    <button onclick="closeModal('fridayTestModal')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6" id="fridayTestModal-body">
                    <form id="fridayTestModal-form">
                        <input type="hidden" id="fridayTestModal-mode" name="mode" value="add">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Jumat</label>
                            <input type="date" id="fridayTestModal-friday_date" name="friday_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded" required>
                            <div id="fridayTestModal-friday_date-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Waktu Sholat</label>
                            <input type="time" id="fridayTestModal-prayer_time" name="prayer_time" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded" required>
                            <div id="fridayTestModal-prayer_time-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Imam</label>
                            <input type="text" id="fridayTestModal-imam_name" name="imam_name" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded" required>
                            <div id="fridayTestModal-imam_name-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Khotib</label>
                            <input type="text" id="fridayTestModal-khotib_name" name="khotib_name" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded" required>
                            <div id="fridayTestModal-khotib_name-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tema Khutbah</label>
                            <input type="text" id="fridayTestModal-khutbah_theme" name="khutbah_theme" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded" required>
                            <div id="fridayTestModal-khutbah_theme-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div id="fridayTestModal-loading" class="hidden text-center py-4">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="ml-2 text-gray-600">Loading...</span>
                        </div>
                        
                        <div id="fridayTestModal-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                            <span id="fridayTestModal-error-message"></span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/modal.js"></script>
    <script src="../assets/js/friday_schedule_modal.js"></script>
    <script>
        /**
         * Unit Tests for Modal JavaScript Functionality
         * Requirements: 2.1, 2.3 (modal open/close functionality and event handling)
         */
        
        let testResults = [];
        let testCount = 0;
        
        // Test result logging
        function logTest(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = {
                timestamp,
                message,
                type,
                id: ++testCount
            };
            
            testResults.push(result);
            
            const resultsContainer = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `[${timestamp}] ${message}`;
            
            resultsContainer.appendChild(resultDiv);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
            
            updateTestSummary();
        }
        
        function updateTestSummary() {
            const summary = document.getElementById('testSummary');
            const passed = testResults.filter(r => r.type === 'pass').length;
            const failed = testResults.filter(r => r.type === 'fail').length;
            const total = testResults.filter(r => r.type !== 'info').length;
            
            summary.innerHTML = `
                <div>Total Tests: ${total}</div>
                <div class="text-green-600">Passed: ${passed}</div>
                <div class="text-red-600">Failed: ${failed}</div>
                <div>Success Rate: ${total > 0 ? Math.round((passed / total) * 100) : 0}%</div>
            `;
        }
        
        function clearResults() {
            testResults = [];
            testCount = 0;
            document.getElementById('testResults').innerHTML = '<div class="text-gray-500 text-sm">Test results cleared...</div>';
            updateTestSummary();
        }
        
        // Basic Modal Functionality Tests
        
        function testModalOpenClose() {
            logTest('Testing basic modal open/close functionality', 'info');
            
            try {
                const modal = document.getElementById('testModal1');
                
                // Test initial state
                if (!modal.classList.contains('hidden')) {
                    throw new Error('Modal should be initially hidden');
                }
                
                // Test open
                openModal('testModal1', { animation: false });
                
                if (!modal.classList.contains('flex') || modal.classList.contains('hidden')) {
                    throw new Error('Modal should be visible after opening');
                }
                
                // Test close
                closeModal('testModal1', { animation: false });
                
                if (!modal.classList.contains('hidden')) {
                    throw new Error('Modal should be hidden after closing');
                }
                
                logTest('✓ Modal open/close functionality works correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ Modal open/close test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        function testModalManager() {
            logTest('Testing ModalManager state tracking', 'info');
            
            try {
                // Clear any existing modals
                ModalManager.openModals.clear();
                
                // Test opening multiple modals
                openModal('testModal1', { animation: false });
                openModal('testModal2', { animation: false });
                
                if (ModalManager.openModals.size !== 2) {
                    throw new Error(`Expected 2 open modals, got ${ModalManager.openModals.size}`);
                }
                
                // Test closing one modal
                closeModal('testModal1', { animation: false });
                
                if (ModalManager.openModals.size !== 1) {
                    throw new Error(`Expected 1 open modal after closing one, got ${ModalManager.openModals.size}`);
                }
                
                // Test closing all modals
                closeModal('testModal2', { animation: false });
                
                if (ModalManager.openModals.size !== 0) {
                    throw new Error(`Expected 0 open modals after closing all, got ${ModalManager.openModals.size}`);
                }
                
                logTest('✓ ModalManager state tracking works correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ ModalManager test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        function testModalUtilityFunctions() {
            logTest('Testing modal utility functions', 'info');
            
            try {
                const modalId = 'testModal1';
                
                // Test updateModalTitle
                updateModalTitle(modalId, 'New Test Title');
                const titleElement = document.getElementById(`${modalId}-title`);
                if (titleElement.textContent !== 'New Test Title') {
                    throw new Error('updateModalTitle failed');
                }
                
                // Test updateModalContent
                updateModalContent(modalId, '<p>New test content</p>');
                const bodyElement = document.getElementById(`${modalId}-body`);
                if (!bodyElement.innerHTML.includes('New test content')) {
                    throw new Error('updateModalContent failed');
                }
                
                // Test showModalLoading
                showModalLoading(modalId, true);
                // Note: This test assumes the modal has loading elements, which testModal1 doesn't
                // So we'll just test that the function doesn't throw an error
                showModalLoading(modalId, false);
                
                logTest('✓ Modal utility functions work correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ Modal utility functions test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        // Event Handling Tests
        
        function testKeyboardNavigation() {
            logTest('Testing keyboard navigation (ESC key)', 'info');
            
            return new Promise((resolve) => {
                try {
                    // Open modal
                    openModal('testModal1', { animation: false });
                    
                    // Simulate ESC key press
                    const escEvent = new KeyboardEvent('keydown', { key: 'Escape' });
                    document.dispatchEvent(escEvent);
                    
                    // Check if modal closed (with small delay for event processing)
                    setTimeout(() => {
                        const modal = document.getElementById('testModal1');
                        if (modal.classList.contains('hidden')) {
                            logTest('✓ ESC key closes modal correctly', 'pass');
                            resolve(true);
                        } else {
                            logTest('✗ ESC key did not close modal', 'fail');
                            resolve(false);
                        }
                    }, 100);
                    
                } catch (error) {
                    logTest(`✗ Keyboard navigation test failed: ${error.message}`, 'fail');
                    resolve(false);
                }
            });
        }
        
        function testBackdropClick() {
            logTest('Testing backdrop click behavior', 'info');
            
            return new Promise((resolve) => {
                try {
                    // Test modal with backdrop close enabled (testModal1)
                    openModal('testModal1', { animation: false });
                    
                    const modal1 = document.getElementById('testModal1');
                    
                    // Simulate backdrop click
                    const clickEvent = new MouseEvent('click', { bubbles: true });
                    Object.defineProperty(clickEvent, 'target', { value: modal1 });
                    modal1.dispatchEvent(clickEvent);
                    
                    setTimeout(() => {
                        if (modal1.classList.contains('hidden')) {
                            logTest('✓ Backdrop click closes modal when enabled', 'pass');
                            
                            // Test modal with backdrop close disabled (testModal2)
                            openModal('testModal2', { animation: false });
                            const modal2 = document.getElementById('testModal2');
                            
                            // Simulate backdrop click
                            const clickEvent2 = new MouseEvent('click', { bubbles: true });
                            Object.defineProperty(clickEvent2, 'target', { value: modal2 });
                            modal2.dispatchEvent(clickEvent2);
                            
                            setTimeout(() => {
                                if (!modal2.classList.contains('hidden')) {
                                    logTest('✓ Backdrop click does not close modal when disabled', 'pass');
                                    closeModal('testModal2', { animation: false }); // Clean up
                                    resolve(true);
                                } else {
                                    logTest('✗ Backdrop click closed modal when it should be disabled', 'fail');
                                    resolve(false);
                                }
                            }, 100);
                            
                        } else {
                            logTest('✗ Backdrop click did not close modal when enabled', 'fail');
                            resolve(false);
                        }
                    }, 100);
                    
                } catch (error) {
                    logTest(`✗ Backdrop click test failed: ${error.message}`, 'fail');
                    resolve(false);
                }
            });
        }
        
        // Form Validation Tests
        
        function testFormValidation() {
            logTest('Testing form validation functionality', 'info');
            
            try {
                const modalId = 'fridayTestModal';
                
                // Test empty form validation
                const isValidEmpty = validateModalForm(modalId);
                if (isValidEmpty) {
                    throw new Error('Empty form should not be valid');
                }
                
                // Test valid form data
                populateModalForm(modalId, {
                    friday_date: getNextFridayDate(),
                    prayer_time: '12:00',
                    imam_name: 'Ustadz Ahmad',
                    khotib_name: 'Ustadz Muhammad',
                    khutbah_theme: 'Pentingnya Sholat Berjamaah'
                });
                
                const isValidFilled = validateModalForm(modalId);
                if (!isValidFilled) {
                    throw new Error('Valid form should pass validation');
                }
                
                // Test invalid date (non-Friday)
                const nonFridayDate = new Date();
                nonFridayDate.setDate(nonFridayDate.getDate() + (nonFridayDate.getDay() === 5 ? 1 : 0));
                
                populateModalForm(modalId, {
                    friday_date: nonFridayDate.toISOString().split('T')[0],
                    prayer_time: '12:00',
                    imam_name: 'Ustadz Ahmad',
                    khotib_name: 'Ustadz Muhammad',
                    khutbah_theme: 'Pentingnya Sholat Berjamaah'
                });
                
                const isValidNonFriday = validateModalForm(modalId);
                if (isValidNonFriday) {
                    throw new Error('Non-Friday date should not be valid');
                }
                
                logTest('✓ Form validation works correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ Form validation test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        function testFormDataHandling() {
            logTest('Testing form data handling functions', 'info');
            
            try {
                const modalId = 'fridayTestModal';
                const testData = {
                    friday_date: getNextFridayDate(),
                    prayer_time: '12:00',
                    imam_name: 'Ustadz Ahmad',
                    khotib_name: 'Ustadz Muhammad',
                    khutbah_theme: 'Pentingnya Sholat Berjamaah'
                };
                
                // Test populateModalForm
                populateModalForm(modalId, testData);
                
                // Test getModalFormData
                const retrievedData = getModalFormData(modalId);
                
                // Verify data matches
                for (const key in testData) {
                    if (retrievedData[key] !== testData[key]) {
                        throw new Error(`Data mismatch for ${key}: expected ${testData[key]}, got ${retrievedData[key]}`);
                    }
                }
                
                // Test resetModalForm
                resetModalForm(modalId);
                const resetData = getModalFormData(modalId);
                
                // Check that required fields are empty after reset
                if (resetData.imam_name || resetData.khotib_name || resetData.khutbah_theme) {
                    throw new Error('Form should be empty after reset');
                }
                
                logTest('✓ Form data handling functions work correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ Form data handling test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        // Friday Schedule Specific Tests
        
        function testFridayDateValidation() {
            logTest('Testing Friday date validation', 'info');
            
            try {
                // Test getNextFriday function
                const nextFriday = FridayScheduleModal.getNextFriday();
                if (nextFriday.getDay() !== 5) {
                    throw new Error('getNextFriday should return a Friday');
                }
                
                // Test date validation in modal setup
                const modalId = 'fridayTestModal';
                FridayScheduleModal.setupModalForSchedule(modalId);
                
                const dateInput = document.getElementById(`${modalId}-friday_date`);
                if (!dateInput.min) {
                    throw new Error('Date input should have minimum date set');
                }
                
                logTest('✓ Friday date validation works correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ Friday date validation test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        function testErrorHandling() {
            logTest('Testing error handling functions', 'info');
            
            try {
                const modalId = 'fridayTestModal';
                
                // Test showModalError
                showModalError(modalId, 'Test error message');
                const errorElement = document.getElementById(`${modalId}-error`);
                if (errorElement.classList.contains('hidden')) {
                    throw new Error('Error should be visible after showModalError');
                }
                
                // Test showFieldError
                showFieldError(modalId, 'imam_name', 'Test field error');
                const fieldErrorElement = document.getElementById(`${modalId}-imam_name-error`);
                if (fieldErrorElement.classList.contains('hidden')) {
                    throw new Error('Field error should be visible after showFieldError');
                }
                
                // Test clearModalErrors
                clearModalErrors(modalId);
                if (!errorElement.classList.contains('hidden') || !fieldErrorElement.classList.contains('hidden')) {
                    throw new Error('Errors should be hidden after clearModalErrors');
                }
                
                logTest('✓ Error handling functions work correctly', 'pass');
                return true;
                
            } catch (error) {
                logTest(`✗ Error handling test failed: ${error.message}`, 'fail');
                return false;
            }
        }
        
        // Helper functions
        
        function getNextFridayDate() {
            const today = new Date();
            const daysUntilFriday = (5 - today.getDay() + 7) % 7;
            const nextFriday = new Date(today);
            nextFriday.setDate(today.getDate() + (daysUntilFriday === 0 ? 7 : daysUntilFriday));
            return nextFriday.toISOString().split('T')[0];
        }
        
        // Test runners
        
        async function runBasicTests() {
            logTest('=== Starting Basic Modal Tests ===', 'info');
            
            const results = [];
            
            results.push(testModalOpenClose());
            results.push(testModalManager());
            results.push(testModalUtilityFunctions());
            results.push(testFormValidation());
            results.push(testFormDataHandling());
            results.push(testFridayDateValidation());
            results.push(testErrorHandling());
            
            const passedTests = results.filter(r => r).length;
            const totalTests = results.length;
            
            logTest(`=== Basic Tests Complete: ${passedTests}/${totalTests} passed ===`, 
                   passedTests === totalTests ? 'pass' : 'fail');
            
            return passedTests === totalTests;
        }
        
        async function runEventTests() {
            logTest('=== Starting Event Handling Tests ===', 'info');
            
            const results = [];
            
            results.push(await testKeyboardNavigation());
            results.push(await testBackdropClick());
            
            const passedTests = results.filter(r => r).length;
            const totalTests = results.length;
            
            logTest(`=== Event Tests Complete: ${passedTests}/${totalTests} passed ===`, 
                   passedTests === totalTests ? 'pass' : 'fail');
            
            return passedTests === totalTests;
        }
        
        async function runAllTests() {
            clearResults();
            logTest('Starting comprehensive modal JavaScript unit tests...', 'info');
            logTest('Requirements: 2.1, 2.3 (modal open/close functionality and event handling)', 'info');
            
            const basicResults = await runBasicTests();
            const eventResults = await runEventTests();
            
            const overallSuccess = basicResults && eventResults;
            
            logTest(`=== All Tests Complete: ${overallSuccess ? 'ALL PASSED' : 'SOME FAILED'} ===`, 
                   overallSuccess ? 'pass' : 'fail');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logTest('Modal JavaScript Unit Test Suite loaded', 'info');
            logTest('Requirements: 2.1, 2.3 (modal open/close functionality and event handling)', 'info');
        });
    </script>
</body>
</html>